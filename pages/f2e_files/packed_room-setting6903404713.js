Do("slider","dialog","effects",function(){$(function(){$.post_withck=function(v,x,y,w){if($.isFunction(x)){w=y;y=x;x={}}return $.ajax({type:"POST",url:v,data:$.extend(x,{ck:get_cookie("ck")}),success:y,dataType:w||"text"})};var m=false,t="",s=dui.Dialog(),a="#ffc",l=$(".widget-tips"),u=$(".sp-fn-box"),c=$("#sp-user"),b=$("#room-rename"),i=b.next(),d=$(".box-close"),f=$(".room-del"),q=$("#new-room"),g=$(".widgets-box"),e=$(".widgets-slider .lnk-add"),k=$('.nav-items li > a:has("em") span'),j=$('.nav-items li > a:has("em") em, .street-editor'),n=$("body").attr("id"),r=$("#room-rename").val(),p="#content .main",o="<em></em>添加成功",h='<span class="txt-added">正在添加</span>';templ_box_loading='<p class="box-loading">正在载入...</p>',isModEmpty=$(".main .sort").length?false:true,showBox=function(v){u.children().hide();c.css("margin-top","0");u.slideDown(v).append(templ_box_loading);setTimeout(function(){$(".box-loading").remove();if($.browser.msie&&$.browser.version==="8.0"){u.children().show()}else{u.children().fadeIn()}g.hide().eq(0).show();if(isRoomEmpty){b.focus()}},v)},DoCreateRoom=function(v){$.post_withck("/j/site/"+n+"/create_room",function(w){if(!w.error){location.href=w.room}else{s.set({width:300,content:w.error,buttons:["confirm"]}).open()}},"json")},roomRename=function(v){k.text(v);$.post_withck("/j/site"+location.pathname+t,{name:v})};g.slider();if(!isSiteFirstEnter&&isRoomEmpty&&isModEmpty){showBox(800)}if(location.pathname.split("/").length===3){t="room_settings/"}else{t="settings/"}l.click(function(){var v=$(this).attr("id").split("-")[1];l.removeClass("selected");$(this).addClass("selected");g.hide();$("#widget-"+v).fadeIn()});f.click(function(w){w.preventDefault();isModEmpty=!$(".main .sort").length&&!$("#div_archives").length?true:false;var v="/j/site/"+n+"/room/"+$(this).attr("id").split("_")[1]+"/settings/delete";if(isModEmpty){s.set({width:300,content:"确定要删除房间？",buttons:[{text:"确定",method:function(x){x.close();$.post_withck(v,{name:r},function(){location.href="/"+n+"/"})}},"cancel"]}).open()}else{s.set({width:300,content:"需要先把空间里的应用模块清理掉 再删除房间",buttons:["confirm"]}).open()}});q.click(function(v){v.preventDefault();$.post_withck("/j/site/"+n+"/create_room_check",function(w){if(w.code=="go_ahead"){DoCreateRoom()}else{if(w.code=="reach_max_limit"){s.set({width:300,content:w.error,buttons:["confirm"]}).open()}else{if(w.code=="dou_not_enough"){s.set({width:300,content:w.error,buttons:[{text:"我知道了",method:function(x){x.close()}}]}).open()}else{if(w.code=="need_confirm"){s.set({width:300,content:w.error,buttons:[{text:"确定增加",method:function(x){x.close();DoCreateRoom(1)}},"cancel"]}).open()}else{if(w.code=="cant_admin_dou"){s.set({width:280,content:w.error,buttons:[{text:"我知道了",method:function(x){x.close()}}]}).open()}}}}}},"json")});j.click(function(v){v.preventDefault();if(u.is(":hidden")){showBox(800);$(this).addClass("current")}else{u.hide();$(this).removeClass();c.css("margin-top","-100px")}});b.keyup(function(w){if(w.keyCode===13){var v=w.target.value;roomRename(v)}});i.click(function(w){var v=b.val();roomRename(v)});d.click(function(v){v.preventDefault();$(this).parent().hide();u.hide();j.removeClass();c.css("margin-top","-100px")});e.click(function(w){w.preventDefault();var v=this,x=w.target.id.split("-")[1];if(!$(this).data("adding")){$(this).data("adding",1);$.post_withck("/j/site"+location.pathname+"widgets",{kind:x},function(y){if(!y.error){$(v).hide().after(h);$(p).prepend(y.html);$(p+" .mod:first").css("backgroundColor",a).animate({backgroundColor:"white"},1500);$(v).next().html(o);setTimeout(function(){$(v).show().next().remove().end().data("adding",0)},10000)}else{s.set({width:300,content:y.error,buttons:["confirm"]}).open()}},"json")}});if(isSiteFirstEnter){(function(){var y=$("body").attr("id"),v='<div class="user-guide"><em></em><h1>{TITLE}</h1><span>{PAGE}</span><p>{CONTENT}</p><a id="{ID}" href="#" class="lnk-add">{BUTTON}</a></div>',x={title:"小站设置",page:"1/2",content:"16套主题模板，让你的小站与众不同。",button:"知道了",id:"next-step"},w={title:"房间改名和添加应用",page:"2/2",content:"不仅可以随心搭配多种精彩的应用，还可以通过拖拽标签来改变房间顺序。",button:"立即开启",id:"close"};$("#room-admin").append(v.replace("{TITLE}",x.title).replace("{PAGE}",x.page).replace("{CONTENT}",x.content).replace("{BUTTON}",x.button).replace("{ID}",x.id));$("#next-step").live("click",function(z){z.preventDefault();$(this).parent().remove();$(".nav-items .on").append(v.replace("{TITLE}",w.title).replace("{PAGE}",w.page).replace("{CONTENT}",w.content).replace("{BUTTON}",w.button).replace("{ID}",w.id));$(".user-guide").css("left","4px")});$("#close").live("click",function(z){z.preventDefault();$(this).parent().remove();showBox(800);$.post_withck("/j/site/"+y+"/tips",{t:"setting"})})})()}})});