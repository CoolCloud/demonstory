(function(){var b="purchasingWidget",c="purchase-";if(typeof Ark==="undefined"){window.Ark={}}function d(e){e=$.extend({yesNoPattern:true,yesText:"重试",noText:"取消"},e);return Ark.confirm(e)}function a(f,e){this._el=f;this.options=$.extend({confirmingTemplate:"#confirm-purchase-tmpl",insuffcientFundsTemplate:"#insufficent-funds-tmpl",purchaseSuccessTemplate:"#purchase-success-tmpl",checkingPassportTemplate:"#checking-passport-tmpl",wrongPasswordTemplate:"#wrong-password-tmpl"},e);this.confirmingTemplate=$(this.options.confirmingTemplate).html();this.insuffcientFundsTemplate=$(this.options.insuffcientFundsTemplate).html();this.purchaseSuccessTemplate=$(this.options.purchaseSuccessTemplate).html();this.checkingPassportTemplate=$(this.options.checkingPassportTemplate).html();this.wrongPassword=$(this.options.wrongPasswordTemplate).html();this._ajax=Ark.ajax;this._template=Ark.template;this._serialize=Ark.serialize;this._button=this._el.find("[data-action=purchase]");this.bindButton(this._button);this.bindConfirmForm(".form-confirm");this._readSampleButton=this._el.find(".btn-preview");this.readSample(this._readSampleButton);this.referrerType="about_to_buy"}$.extend(a.prototype,Ark.PurchaseMixinGa,{bindButton:function(f){var e=this;f.on("click",function(g){g.preventDefault();e.checkPrecond()})},bindConfirmForm:function(e){$(document).on("submit",e,function(f){f.preventDefault();$(this).find("[data-confirm=true]").trigger("click")})},readSample:function(f){var e=this;f.click(function(){Ark.ga.trackEvent("purchase","sample",e.getTitle())})},isFree:function(){return !this.getPriceInCents()},getPrice:function(){return this._el.data("readable-price")},getPriceInCents:function(){return this._el.data("price")},confirmPurchasing:function(e){return this.isFree()?$.Deferred().resolve():Ark.confirm({title:"购买作品",content:this.renderPurchasing(e)})},oncheckingPrecond:function(){if(this.isFree()){this.fulfillPrecond();return}this.trackPurchaseEvent("tryToBuy");this._checkBalance()},_checkBalance:function(){var e=this;Ark.alert({title:"检查余额",content:"正在检查账户余额，请稍候..."});this._ajax.get("/j/balance").done(function(g){var f=parseInt(g,10);if(f>=e.getPriceInCents()){e.fulfillPrecond(f)}else{e.trackRechargeEvent("insufficience");e.failPrecond();e.confirmDepositing({amount:e.getPriceInCents()-f,referrerType:e.referrerType})}}).fail(function(){e.trackPurchaseEvent("checkBalanceFailed");d({title:"出错了",content:"无法获取账户余额，也许是网络连接出现了问题。"}).done(function(){e._checkBalance()}).fail(function(){e.failPrecond()})})},oncheckPassport:function(g,f,j,h){var e=this,i={email:h.email};this._checkCaptcha(h).done(function(k){i.needCaptcha=k.limited;if(k.limited){i.captchaId=k.captcha_id;i.captchaUrl=k.captcha_url}e._checkPassword(i,h)}).fail(function(k){k=k||"发生了未知的错误";e.trackPurchaseEvent("fetchCaptchaFailed:"+k);d({title:"出错了",content:"检查账户登录状态时，出现了问题。"}).done(function(){e.oncheckPassport(g,f,j,h)}).fail(function(){e.failPassport()})})},_checkCaptcha:function(e){Ark.alert({title:"获取验证",content:"正在获取验证信息，请稍候..."});return $.dataPoster(e.verify_url,{},function(){},"post","json")},_checkPassword:function(g,f){var e=this;Ark.confirm({title:"登录密码",width:350,content:e._template(e.checkingPassportTemplate,g)}).done(function(i){var h=i.panel,j=e._serialize(h.find(".form-check-pass"));Ark.alert({title:"验证密码",content:"正在验证登录密码，请稍候..."});j.verify=1;e._sendPassword(f.verify_url,j)}).fail(function(){e.cancelPassport()});dui.overlay().panel.find(".input-password").focus()},_sendPassword:function(f,g){var e=this;return $.dataPoster(f,g,function(h){if(h&&h.ok){e.donePassport();e._confirmToBuy()}else{Ark.confirm({title:"登录失败",content:e.wrongPassword}).done(function(){e.ongetBought()}).fail(function(){e.failPassport()})}},"post","json").fail(function(){e.trackPurchaseEvent("validatePasswordFailed");d({title:"出错了",content:"无法进行登录，也许是网络连接出现了问题。"}).done(function(){e._sendPassword(f,g)}).fail(function(){e.failPassport()})})},onreadyToBuy:function(g,i,h,e){var f=this;if(this.isFree()){this.buyAsFree();return}f.confirmPurchasing({balance:(e/100).toFixed(2)}).done(function(j){f.secretly=j.panel.find("[name=secretly]:checked").val();f.getBought()}).fail(function(){f.cancel()})},renderPurchasing:function(e){return this._template(this.confirmingTemplate,$.extend({},e,this._el.data()))},onbuyAsFree:function(){this._confirmToBuy()},onbeforegetBought:function(){return !!this._button},ongetBought:function(){var e=this;Ark.alert({title:"检查账号",content:"正在检查你的账号，请稍候..."});this._ajax.get("/j/check_pay_verify").done(function(f){if(!f.verified){e.checkPassport(f)}else{e._confirmToBuy()}}).fail(function(){e.trackPurchaseEvent("checkAuthStatusFailed");d({title:"出错了",content:"检查账户购买状态时，出现了问题。"}).done(function(){e.ongetBought()}).fail(function(){e.failedToBuy()})})},_confirmToBuy:function(){var e=this;e._requestToBuy().done(function(f){if(!f||f.r){return e.failedToBuy(f?f.err:"不知道怎么回事..")}else{return e.succeededToBuy(f)}}).fail(function(){e.trackPurchaseEvent("finalPurchaseFailed");d({title:"出错了",content:"无法完成购买操作，也许是网络连接出现了问题。"}).done(function(){e._confirmToBuy()}).fail(function(){e.failedToBuy()})})},getHref:function(){return this._button.data("href")},getTitle:function(){return this._el.data("title")},getArticleId:function(){return this._el.data("article-id")},_requestToBuy:function(){var f=document.referrer;var e=Ark.alert({title:"确认购买",content:"正在确认购买，请稍候..."});return this._ajax({type:"POST",url:this.getHref(),dataType:"json",arkWithDocReferer:true,data:{secretly:this.secretly||""}}).always(function(){e.close()})},onsucceededToBuy:function(f,i,h,g){if(this.isFree()){this.trackPurchaseEvent("got")}else{this.trackPurchaseEvent("bought");this.trackEcommerce(g.order,"store","购买")}var e=this._el;e.empty().append($("<span />",{"class":"price-tag",text:"已购买"})).append($("<a />",{"class":"btn btn-read",href:"/reader/ebook/"+e.data("article-id")+"/",text:"阅读",target:"_blank"}))},onfailedToBuy:function(f,h,g,e){this.trackPurchaseEvent("failed");if(!e){return}Ark.alert({title:"出错了",content:e,timeout:3000})},onbought:function(){if(!this.isFree()){this.showSuccessAlert()}},showFailAlert:function(){Ark.alert({title:"支付失败",content:"登录错误, 请重新购买",timeout:3000,width:400}).done($.proxy(function(){this.checkPrecond()},this))},showSuccessAlert:function(){Ark.alert({title:"购买成功",content:this.purchaseSuccessTemplate,timeout:3000,width:400})},confirmDepositing:function(f){var e=this;return Ark.confirm({title:"余额不足",content:e._template(this.insuffcientFundsTemplate,$.extend(f,this._el.data()))}).done(function(){e.trackRechargeEvent("tryToRechargeDialogue")})},onchangestate:function(e,g,f){this._el.removeClass(c+g).addClass(c+f)}});StateMachine.create({target:a.prototype,events:[{name:"getBought",from:"readyToBuy",to:"buying"},{name:"checkPassport",from:["buying","checkingPassport"],to:"checkingPassport"},{name:"donePassport",from:"checkingPassport",to:"buying"},{name:"failPassport",from:"checkingPassport",to:"none"},{name:"checkPrecond",from:"none",to:"checkingPrecond"},{name:"failPrecond",from:"checkingPrecond",to:"none"},{name:"cancel",from:"readyToBuy",to:"none"},{name:"cancelPassport",from:"checkingPassport",to:"none"},{name:"fulfillPrecond",from:"checkingPrecond",to:"readyToBuy"},{name:"failedToBuy",from:"buying",to:"none"},{name:"succeededToBuy",from:"buying",to:"bought"},{name:"buyAsFree",from:"readyToBuy",to:"buying"}]});a.applyWithIn=function(e,f){$(f).find(e).each(function(g,h){h=$(h);var j=h.data(b);if(!j){j=new a(h);h.data(b,j)}})};Ark.PurchaseWidget=a})();