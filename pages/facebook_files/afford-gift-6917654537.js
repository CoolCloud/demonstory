define("widget/afford-gift",["mod/ajax","lib/fsm","ui/confirm","ui/alert","mod/template","mod/ga","widget/purchase-mixin/ga"],function(){var b="affordGiftWidget",c="afford-gift-";function d(e){e=$.extend({yesNoPattern:true,yesText:"重试",noText:"取消"},e);return Ark.confirm(e)}function a(f,e){this.options=$.extend({insuffcientFundsTemplate:"#insufficent-funds-tmpl"},e);this.insuffcientFundsTemplate=$(this.options.insuffcientFundsTemplate).html();this._el=f;this._button=this._el;this._ajax=Ark.ajax;this.bindButton(this._button);this.referrerType="about_to_gift"}$.extend(a.prototype,Ark.PurchaseMixinGa,{bindButton:function(f){var e=this;f.on("click",function(g){g.preventDefault();e.trackPurchaseEvent("tryToGift");e.checkPrecond()})},isFree:function(){return !this.getPriceInCents()},getPrice:function(){return this._el.data("readable-price")},getPriceInCents:function(){return this._el.data("price")},oncheckingPrecond:function(){if(this.isFree()){this.fulfillPrecond();return}this._checkBalance()},_checkBalance:function(){var e=this;Ark.alert({title:"检查余额",content:"正在检查账户余额，请稍候..."});this._ajax.get("/j/balance").done(function(g){var f=parseInt(g,10);if(f>=e.getPriceInCents()){e.fulfillPrecond(f)}else{e.failPrecond();e.confirmDepositing({amount:e.getPriceInCents()-f,referrerType:e.referrerType})}}).fail(function(){e.trackPurchaseEvent("checkBalanceFailed");d({title:"出错了",content:"无法获取账户余额，也许是网络连接出现了问题。"}).done(function(){e._checkBalance()}).fail(function(){e.failPrecond()})})},onreadyToBuyGift:function(e,g,f){Ark.alert({title:"检查余额",content:"余额检查成功，正在跳转, 请稍侯..."});location.replace(this.getHref())},getTitle:function(){return this._el.data("title")},getArticleId:function(){return this._el.data("article-id")},getHref:function(){return this._button.data("href")},confirmDepositing:function(f){var e=this;return Ark.confirm({title:"余额不足",content:Ark.template(this.insuffcientFundsTemplate,$.extend(f,this._el.data()))}).done(function(){e.trackRechargeEvent("tryToRechargeDialogue")})},onchangestate:function(e,g,f){this._el.removeClass(c+g).addClass(c+f)}});StateMachine.create({target:a.prototype,events:[{name:"checkPrecond",from:"none",to:"checkingPrecond"},{name:"failPrecond",from:"checkingPrecond",to:"none"},{name:"fulfillPrecond",from:"checkingPrecond",to:"readyToBuyGift"}]});a.applyWithIn=function(e,f){$(f).find(e).each(function(g,h){h=$(h);var j=h.data(b);if(!j){j=new a(h);h.data(b,j)}})};return a});